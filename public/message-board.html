<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Board</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/dark-theme.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <style>
        .message-card {
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-radius: 12px;
            margin-bottom: 24px;
        }
        .reply {
            margin-left: 32px;
            margin-top: 10px;
            padding-left: 16px;
            border-left: 2px solid #e0e0e0;
        }
        .reply-user {
            font-weight: 500;
            margin-right: 8px;
        }
        .reply-date {
            color: #888;
            font-size: 0.9em;
            margin-left: 8px;
        }
        .message-meta {
            color: #888;
            font-size: 0.95em;
        }
        .message-content {
            margin: 10px 0 0 0;
            font-size: 1.1em;
        }
        .reply-list {
            margin-top: 10px;
        }
        .reply-form textarea {
            resize: none;
        }
        .card-anon {
            font-weight: 600;
        }
    </style>
</head>
<body class="dark-bg">
    <div class="animated-lines-bg" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:0;pointer-events:none;">
        <svg width="100%" height="100%" viewBox="0 0 1200 800" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path id="wave1" d="M0 400 Q300 200 600 400 T1200 400" stroke="#ff3c6a" stroke-width="6" fill="none"/>
            <path id="wave2" d="M0 500 Q300 700 600 500 T1200 500" stroke="#36cfff" stroke-width="6" fill="none"/>
            <path id="wave3" d="M0 300 Q300 100 600 300 T1200 300" stroke="#ffb347" stroke-width="4" fill="none"/>
            <path id="wave4" d="M0 600 Q300 800 600 600 T1200 600" stroke="#46ffb3" stroke-width="4" fill="none"/>
            <animate xlink:href="#wave1" attributeName="d" values="M0 400 Q300 200 600 400 T1200 400;M0 400 Q300 300 600 400 T1200 400;M0 400 Q300 200 600 400 T1200 400" dur="8s" repeatCount="indefinite"/>
            <animate xlink:href="#wave2" attributeName="d" values="M0 500 Q300 700 600 500 T1200 500;M0 500 Q300 600 600 500 T1200 500;M0 500 Q300 700 600 500 T1200 500" dur="10s" repeatCount="indefinite"/>
            <animate xlink:href="#wave3" attributeName="d" values="M0 300 Q300 100 600 300 T1200 300;M0 300 Q300 200 600 300 T1200 300;M0 300 Q300 100 600 300 T1200 300" dur="12s" repeatCount="indefinite"/>
            <animate xlink:href="#wave4" attributeName="d" values="M0 600 Q300 800 600 600 T1200 600;M0 600 Q300 700 600 600 T1200 600;M0 600 Q300 800 600 600 T1200 600" dur="14s" repeatCount="indefinite"/>
        </svg>
    </div>
    <div class="container mt-5" style="max-width: 700px; z-index:1; position:relative;">
        <div class="glass-card text-light p-4">
            <h3 class="mb-4" style="color:#36cfff;"><i class="bi bi-chat-left-text"></i> Recent Messages</h3>
            <div class="card p-3 mb-4 bg-transparent border-0">
                <textarea id="new-message" class="form-control mb-2 dark-input" rows="3" placeholder="Share your thoughts..."></textarea>
                <button id="share-btn" class="btn btn-gradient-glow align-self-end" style="width:120px;"><i class="bi bi-send"></i> Share</button>
            </div>
            <div id="messages-list"></div>
        </div>
    </div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script>
        // Fetch and render messages
        async function fetchMessages() {
            const res = await fetch('/api/messages');
            const data = await res.json();
            const list = document.getElementById('messages-list');
            list.innerHTML = '';
            if (data.success && data.messages.length) {
                data.messages.forEach(msg => {
                    const card = document.createElement('div');
                    card.className = 'card message-card p-3';
                    let user = msg.is_anonymous ? '<i class="bi bi-person-fill"></i> <span class="card-anon">Anonymous</span>' : `<i class="bi bi-person-circle"></i> ${msg.author_name || 'User'}`;
                    let date = `<i class='bi bi-clock'></i> ${new Date(msg.created_at).toLocaleDateString()}`;
                    card.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>${user}</div>
                            <div class="message-meta">${date}</div>
                        </div>
                        <div class="message-content">${msg.content}</div>
                        <div class="reply-list" id="replies-${msg.id}"></div>
                        <form class="reply-form mt-2" data-id="${msg.id}">
                            <textarea class="form-control mb-2" rows="2" placeholder="Write a supportive reply..."></textarea>
                            <button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-reply"></i> Reply</button>
                        </form>
                    `;
                    list.appendChild(card);
                    fetchReplies(msg.id);
                });
            } else {
                list.innerHTML = '<div class="text-center text-muted">No messages yet.</div>';
            }
        }
        // Fetch and render replies for a message
        async function fetchReplies(messageId) {
            const res = await fetch(`/api/messages/${messageId}`);
            const data = await res.json();
            if (data.success && data.message.replies.length) {
                const repliesDiv = document.getElementById(`replies-${messageId}`);
                data.message.replies.forEach(reply => {
                    const replyDiv = document.createElement('div');
                    replyDiv.className = 'reply';
                    let user = `<span class="reply-user"><i class="bi bi-person-circle"></i> ${reply.author_name || 'User'}</span>`;
                    let date = `<span class="reply-date"><i class='bi bi-clock'></i> ${new Date(reply.created_at).toLocaleDateString()}</span>`;
                    replyDiv.innerHTML = `${user} ${date}<div>${reply.content}</div>`;
                    repliesDiv.appendChild(replyDiv);
                });
            }
        }
        // Post a new message
        document.getElementById('share-btn').onclick = async () => {
            const textarea = document.getElementById('new-message');
            const content = textarea.value.trim();
            if (!content) return;
            const res = await fetch('/api/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: 'New Message', content, isAnonymous: false })
            });
            const data = await res.json();
            if (data.success) {
                textarea.value = '';
                fetchMessages();
            } else {
                alert('Failed to post message.');
            }
        };
        // Post a reply
        document.addEventListener('submit', async (e) => {
            if (e.target.classList.contains('reply-form')) {
                e.preventDefault();
                const form = e.target;
                const messageId = form.getAttribute('data-id');
                const textarea = form.querySelector('textarea');
                const content = textarea.value.trim();
                if (!content) return;
                const res = await fetch(`/api/messages/${messageId}/replies`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                const data = await res.json();
                if (data.success) {
                    textarea.value = '';
                    fetchMessages();
                } else {
                    alert('Failed to post reply.');
                }
            }
        });
        // Initial load
        fetchMessages();
    </script>
</body>
</html> 